## AMQP (Advanced Message Queuing Protocol)

AMQP é um protocolo de comunicação assíncrona entre sistemas internos / microserviços.

<img src="https://www.cloudamqp.com/img/docs/camqp.png" alt="">

<br>

## Como funciona?

Uma pessoa (Producer) escreve uma carta.
Nessa carta existe o conteúdo (payload) e o endereço de destino (routing key).
Essa pessoa leva a carta até uma agência dos Correios (RabbitMQ – Broker).

<br>

Ao chegar na agência dos Correios (RabbitMQ – Broker), a carta não vai direto para o destino.
Primeiro, ela passa por um caixa de atendimento (Exchange).

<br>

A Exchange (caixa de atendimento) analisa o endereço da carta (routing key)
e compara com a sua lista de destinos cadastrados (bindings).

<br>

Quando a Exchange encontra um endereço compatível, ela encaminha a carta para a caixa postal correta (fila / queue).

<br>

A carta fica guardada nessa caixa postal (fila / queue) até que o destinatário esteja disponível.

<br>

O destinatário (Consumer) vai até a caixa postal (fila / queue), pega a carta e lê o conteúdo.

<hr>
<br>

## Conceitos de RabbitMQ

Conceitos importantes precisam estar claros:

- **Broker**: Software que gerencia  as mensagens, utilizando o protocolo AMQP. 

     Exemplo: RabbitMQ.

<br>

- **Producer**: Aplicação que cria e envia mensagens para o broker, que envia para uma exchange.

<br>

- **Consumer**: Aplicação que consome e processa as mensagens das filas.

<br>

- **Exchanges**: Decide para qual fila a mensagem deve ser enviada, com base no endereco da mensagem.

<br>

- **Routing Key**:  Endereço que o Producer coloca na mensagem. A Exchange usa essa chave para decidir o destino da mensagem.

<br>


- **Binding** (Vínculo): É a conexão ou "regra" que liga uma Exchange a uma Fila.

<br>

- **Queues**(filas): Onde as mensagens ficam armazenadas até serem consumidas.

<br>

- **Binding Key (Chave de Vínculo)**: A Exchange usa essa Binding Key para comparar com a Routing Key da mensagem e, assim, decidir se a mensagem deve ser enviada para aquela fila.

<br>

- **Message**: Informação enviada do produtor para o consumidor através do RabbitMQ.

<hr>
<br>

## Exchange (O Distribuidor de Mensagens)

A Exchange é o componente responsável por receber as mensagens do Producer e decidir para qual fila (ou filas) essas mensagens devem ser enviadas.

Ela não armazena mensagens.
A função da Exchange é apenas rotear as mensagens.

<br>

Esse roteamento acontece comparando:

- a Routing Key da mensagem
- com as Binding Keys configuradas entre a Exchange e as filas

<br>

Dependendo do tipo de Exchange (direct, topic, fanout, headers), a forma como essa decisão é feita pode mudar.

<br>
<br>

### Tipos de Exchange

O jeito que a Exchange decide para onde mandar a mensagem depende do seu **tipo**. 

Os principais são:

 1. Direct -> Envia pra uma fila específica.

 2. Fanout -> Envia pra porra toda. Todas as filas

 3. Topic -> Envia para todas as filas da mesma categoria

<br>
<br>


#### 1. Direct

Envia a mensagem diretamente para uma fila específica.

A Exchange verifica a Routing Key da mensagem e compara com a Binding Key das filas que ela conhece.

Usamos quando sabemos exatamente para qual fila queremos enviar a mensagem.

<img src="../img/rabbitmq_exchange_direct_1.png">

<br>

<img src="../img/rabbitmq_exchange_direct_2.png">



<br>
<br>

#### 2. Fanout

A Fanout Exchange ignora a Routing Key.
Ou seja, não importa o endereço da mensagem, ela será enviada para todas as filas conectadas.

<img src="../img/rabbitmq_exchange_fanout.png">


<br>

Exemplo um serviço de notificacao. Vamos ter varias filas:

- fila de sms
- fila de whatsapp
- fila de email


<hr>
<br>

### ACK

ACK é um sinal que o consumidor envia de volta para o RabbitMQ, dizendo: "Ok, recebi e processei essa mensagem! Pode apagar da fila."

Se o consumidor não envia o ACK (porque falhou ou não terminou), a mensagem fica lá para ser entregue de novo.

⚠️ melhorar resumo depois...